<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><!--  文字のエンコーディング -->
    <title>CSV 3D Visualization</title><!--  タブのタイトル -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script> <!--  A-Frame読み込み -->
    <style>/* CSSを記述 */
        #ui {
            position: fixed; /* 位置固定 */
            top: 12px; /* 上から12ピクセル */
            left: 12px; /* 左から12ピクセル */
            z-index: 9999; /* 順序を表す。値が大きいほど他の要素の上に表示される */
        }
    </style>
</head>
<body>
	<div id="ui"> <!-- #uiの部分 -->
    <input type="file" id="csvFile" accept=".csv"> <!-- csvファイルを選択できるファイル入力要素を作成、csvファイルのみ -->
	</div>
    <a-scene>
        <a-plane position="0 0 0" rotation="-90 0 0" width="20" height="20" color="#333333"></a-plane> <!-- 位置や向きを設定 -->
        <a-sky color="#222222"></a-sky> <!-- 背景の色を設定 -->
    </a-scene>

    <script>//　ここからJS開始
    document.getElementById('csvFile').addEventListener('change', function(e) {// ファイルを入れた時のイベントリスナーを追加
        const file = e.target.files[0]; // ファイルの最初のものを取得

        if (file) { //ファイルが存在するかの確認
            const reader = new FileReader(); // FileReaderを使ってファイルを読み込む

            reader.onload = function(e) { // ファイル読み込みが完了した時のイベント
                const text = e.target.result; // textに格納
                const data = parseCSV(text); // parseCSV関数に渡し、JSオブジェクトの配列に変換
                displayData(data); // displayData関数に渡し、3Dオブジェクトを表示
            };
            reader.readAsText(file); // ファイルをテキストとして読み込む。
        }
    });

    function parseCSV(text) { // csvテキスト文字列を配列に変換する関数を定義
        const lines = text.split('\n'); // 行ごとに分割
        const data = []; //リストを作成

        for (let i = 1; i < lines.length; i++) { // 1行目はヘッダー→ 2行目から開始
            if (lines[i].trim() === '') continue; // 空白文字を削除、空行の場合リセット

            const values = lines[i].split(','); // カンマで分割

            const item = { // 新しいオブジェクト作成(列はcsvファイルの値)
                name: values[0], // 1列目の値をnameに
                value: parseFloat(values[1]), // 2列目の値を数値に変換してvalueに
                lat: parseFloat(values[2]), // 3列目の値を数値に変換してlatに
                lon: parseFloat(values[3]) // 4列目の値を数値に変換してlonに
            };

            data.push(item); // 作成したオブジェクトをdataリストに追加
        }

        return data; // 変換したデータの配列を返す
    }

    function displayData(data) { // 3Dオブジェクトを表示する関数を定義
        const scene = document.querySelector('a-scene'); // A-Frameの要素を取得

        data.forEach((item, index) => {// forEachはJSのfor文,関数を一回実行するごとにitemに値が入る
            const height = item.value / 20; // 3Dオブジェクトの高さを計算(値を20で割る)

            const cylinder = document.createElement('a-cylinder'); // a-cyalinderの要素作成
            const x = index * 3 - 6; // x座標
            const y = height / 2; //y座標
            const z = -5; // z座標

            cylinder.setAttribute('position', `${x - 3} ${y} ${z}`);
            cylinder.setAttribute('radius', '0.5');
            cylinder.setAttribute('height', height);
            cylinder.setAttribute('color', '#00ff00');

            scene.appendChild(cylinder); // 作成した要素をシーンに追加

            const text = document.createElement('a-text'); //テキスト要素作成
            text.setAttribute('value', `${item.name}\n${item.value}`);
            text.setAttribute('position', `${x - 3} ${height + 0.5} ${z}`);
            text.setAttribute('color', 'white');
            text.setAttribute('align', 'center'); //テキストの配置を中央揃えに設定

            scene.appendChild(text); // 作成したテキスト要素をシーンに追加
        });
    }
    </script>
</body>
</html>
