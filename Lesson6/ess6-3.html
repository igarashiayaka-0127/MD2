<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Japan Map 3D Visualization</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <style>
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 999;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="controls">
        <p>CSVファイルを選択</p>
        <input type="file" id="csvFile" accept=".csv">
    </div>

    <a-scene>
        <!-- 地図画像 -->
        <a-plane src="japan_map.png" scale="40 40 40" rotation="-90 0 0" position="-4.16115 -0.077 -1.783"></a-plane>
        <!-- カメラ設定 -->
        <a-camera position="0 15 10" rotation="-50 0 0"></a-camera>

        <!-- 照明 -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="0 10 0" color="#ffffff"></a-light>

        <a-sky color="#000033"></a-sky>
        
    </a-scene>

    <script>
        // 日本の中心座標
        const centerLat = 36.0;
        const centerLon = 138.0;

        document.getElementById('csvFile').addEventListener('change', function (e) {
            const file = e.target.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    const text = e.target.result;
                    const data = parseCSV(text);
                    displayOnMap(data);
                };

                reader.readAsText(file);
            }
        });

        function parseCSV(text) {
            const lines = text.split('\n');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                const values = lines[i].split(',');

                const item = {
                    name: values[0],
                    value: parseFloat(values[1]),
                    lat: parseFloat(values[2]),
                    lon: parseFloat(values[3])
                };

                data.push(item);
            }

            return data;
        }

        function latLonToPosition(lat, lon) {
            const x = (lon - centerLon) * 2;
            const z = -(lat - centerLat) * 2;

            return { x: x, z: z };
        }

        function displayOnMap(data) {
            const scene = document.querySelector('a-scene');

            // 既存の要素を削除
            const oldElements = scene.querySelectorAll('.datapoint');
            oldElements.forEach(el => el.remove());

            data.forEach(item => {
                const pos = latLonToPosition(item.lat, item.lon);
                const height = item.value / 20;

                // 円柱
                const cylinder = document.createElement('a-cylinder');
                cylinder.classList.add('datapoint');
                cylinder.setAttribute('position', `${pos.x} ${height / 2} ${pos.z}`);
                cylinder.setAttribute('radius', '0.3');
                cylinder.setAttribute('height', height);
                cylinder.setAttribute('color', getColor(item.value));

                scene.appendChild(cylinder);

                // ラベル
                const text = document.createElement('a-text');
                text.classList.add('datapoint');
                text.setAttribute('value', `${item.name}\n${item.value}`);
                text.setAttribute('position', `${pos.x} ${height + 1} ${pos.z}`);
                text.setAttribute('color', 'black');
                text.setAttribute('align', 'center');
                text.setAttribute('width', '18');

                scene.appendChild(text);
            });
        }

        function getColor(value) {
            if (value >= 80) return '#ff0000';
            if (value >= 60) return '#ffff00';
            if (value >= 40) return '#00ff00';
            return '#0000ff';
        }
    </script>
</body>

</html>